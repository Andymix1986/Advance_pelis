<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Player Shaka</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.3.0/shaka-player.compiled.js"></script>
  <style>
    body,html {
      margin:0;
      padding:0;
      background:black;
      height:100%;
      width:100%;
      overflow:hidden;
    }
    #video {
      width:100%;
      height:100%;
      background:black;
    }
    #overlay {
      position: absolute;
      top:0; left:0;
      width:100%; height:100%;
      background: rgba(0,0,0,0.8);
      display:flex;
      align-items:center;
      justify-content:center;
      color:white;
      font-size:2em;
      flex-direction: column;
      z-index: 10;
    }
    .loader {
      border: 6px solid #f3f3f3;
      border-top: 6px solid orange;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }
  </style>
</head>
<body>
  <div id="overlay">
    <div class="loader"></div>
    <div id="overlayText">Cargando...</div>
  </div>
  <video id="video" autoplay muted playsinline></video>

  <script>
    // Obtener parámetros de URL
    const params = new URLSearchParams(window.location.search);
    let videoUrl   = decodeURIComponent(params.get("url"));
    const titulo   = decodeURIComponent(params.get("titulo"));
    const tipo     = params.get("tipo");
    const id       = params.get("id");
    let temporada  = parseInt(params.get("temporada"));
    let capitulo   = parseInt(params.get("capitulo"));
    const total    = parseInt(params.get("total"));

    const video = document.getElementById("video");
    const overlay = document.getElementById("overlay");
    const overlayText = document.getElementById("overlayText");

    // Inicializar Shaka Player
    const player = new shaka.Player(video);

    player.addEventListener('error', e => console.error('Error Shaka:', e.detail));

    // Restaurar progreso
    const progressKey = `progress_${id}_${temporada}_${capitulo}`;
    const savedTime = localStorage.getItem(progressKey);

    function loadVideo(url, resumeTime=0) {
      overlay.style.display = "flex";
      overlayText.textContent = capitulo === total-1 ? "Fin de Temporada" : "Cargando...";
      player.load(url).then(() => {
        if (resumeTime > 0) video.currentTime = resumeTime;
        overlay.style.display = "none";
        video.play();
      }).catch(e => console.error("Shaka load error:", e));
    }

    loadVideo(videoUrl, savedTime ? parseFloat(savedTime) : 0);

    // Guardar progreso en tiempo real
    video.addEventListener("timeupdate", () => {
      localStorage.setItem(progressKey, video.currentTime);
    });

    // Salto automático
    video.addEventListener("ended", () => {
      if (capitulo + 1 < total) {
        capitulo++;
        const nextIdNum = parseInt(videoUrl.match(/(\d+)\.mkv$/)[1]) + 1;
        videoUrl = videoUrl.replace(/(\d+)\.mkv$/, nextIdNum + ".mkv");

        // Guardar último visto
        localStorage.setItem("ultimoCapituloVisto", JSON.stringify({id, temporada, capitulo}));

        overlay.style.display = "flex";
        overlayText.textContent = "Cargando siguiente capítulo...";

        setTimeout(() => {
          const nextProgressKey = `progress_${id}_${temporada}_${capitulo}`;
          const nextSavedTime = localStorage.getItem(nextProgressKey);
          loadVideo(videoUrl, nextSavedTime ? parseFloat(nextSavedTime) : 0);
        }, 1000);

      } else {
        // Fin de temporada
        overlay.style.display = "flex";
        overlayText.textContent = "Fin de Temporada";
        localStorage.setItem("ultimoCapituloVisto", JSON.stringify({id, temporada, capitulo}));
        setTimeout(() => window.close(), 3000);
      }
    });
  </script>
</body>
</html>
