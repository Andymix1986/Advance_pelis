<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Player</title>
  <style>
    body,html {
      margin:0;
      padding:0;
      background:black;
      height:100%;
      width:100%;
      overflow:hidden;
    }
    #video {
      width:100%;
      height:100%;
      background:black;
    }
    #overlay {
      position: absolute;
      top:0; left:0;
      width:100%; height:100%;
      background: rgba(0,0,0,0.8);
      display:flex;
      align-items:center;
      justify-content:center;
      color:white;
      font-size:2em;
      flex-direction: column;
      z-index: 10;
    }
    .loader {
      border: 6px solid #f3f3f3;
      border-top: 6px solid orange;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }
  </style>
</head>
<body>
  <div id="overlay">
    <div class="loader"></div>
    <div id="overlayText">Cargando...</div>
  </div>
  <video id="video" controls autoplay></video>

  <script>
    // ----------- 1. obtener parámetros de la URL ------------
    const params = new URLSearchParams(window.location.search);
    let videoUrl   = decodeURIComponent(params.get("url"));
    const titulo   = decodeURIComponent(params.get("titulo"));
    const tipo     = params.get("tipo");
    const id       = params.get("id");
    let temporada  = parseInt(params.get("temporada"));
    let capitulo   = parseInt(params.get("capitulo"));
    const total    = parseInt(params.get("total"));

    const video = document.getElementById("video");
    const overlay = document.getElementById("overlay");
    const overlayText = document.getElementById("overlayText");

    // ----------- 2. reproducir video -----------------
    video.src = videoUrl;

    // ----------- 3. restaurar progreso -----------------
    const progressKey = `progress_${id}_${temporada}_${capitulo}`;
    const savedTime = localStorage.getItem(progressKey);
    if (savedTime) {
      video.currentTime = parseFloat(savedTime);
    }

    // ----------- 4. guardar progreso -----------------
    video.addEventListener("timeupdate", () => {
      localStorage.setItem(progressKey, video.currentTime);
    });

    // ----------- 5. ocultar overlay cuando cargue -----
    video.addEventListener("canplay", () => {
      overlay.style.display = "none";
    });

    // ----------- 6. salto automático -----------------
    video.addEventListener("ended", () => {
      if (capitulo + 1 < total) {
        // Siguiente capitulo
        capitulo++;
        const nextIdNum = parseInt(videoUrl.match(/(\d+)\.mkv$/)[1]) + 1;
        videoUrl = videoUrl.replace(/(\d+)\.mkv$/, nextIdNum + ".mkv");

        // mostrar overlay
        overlay.style.display = "flex";
        overlayText.textContent = "Cargando siguiente capítulo...";

        // guardar último visto
        localStorage.setItem("ultimoCapituloVisto", JSON.stringify({id, temporada, capitulo}));

        setTimeout(() => {
          video.src = videoUrl;
          video.load();
          video.play();
        }, 2000);

      } else {
        // Fin de temporada
        overlay.style.display = "flex";
        overlayText.textContent = "Fin de Temporada";
        setTimeout(() => {
          window.close(); // cierra el player (en WebView funciona)
        }, 3000);
      }
    });
  </script>
</body>
</html>
